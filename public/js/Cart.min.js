jQuery(function($) {
    if (typeof wc_cart_fragments_params === 'undefined') {
        return false;
    }

    const $supports_html5_storage = (() => {
        try {
            const storage = window.sessionStorage;
            storage.setItem('wc', 'test');
            storage.removeItem('wc');
            return true;
        } catch (err) {
            return false;
        }
    })();

    const cart_hash_key = wc_cart_fragments_params.cart_hash_key;

    const setCartCreationTimestamp = () => {
        if ($supports_html5_storage) {
            sessionStorage.setItem('wc_cart_created', Date.now());
        }
    };

    const setCartHash = (hash) => {
        if ($supports_html5_storage) {
            localStorage.setItem(cart_hash_key, hash);
            sessionStorage.setItem(cart_hash_key, hash);
        }
    };

    const fragmentRefresh = {
        url: wc_cart_fragments_params.wc_ajax_url.toString().replace('%%endpoint%%', 'get_refreshed_fragments'),
        type: 'POST',
        data: {
            time: Date.now()
        },
        timeout: wc_cart_fragments_params.request_timeout,
        success: (data) => {
            if (data?.fragments) {
                $.each(data.fragments, (key, value) => $(key).replaceWith(value));
                if ($supports_html5_storage) {
                    sessionStorage.setItem(wc_cart_fragments_params.fragment_name, JSON.stringify(data.fragments));
                    setCartHash(data.cart_hash);
                    if (data.cart_hash) setCartCreationTimestamp();
                }
                $(document.body).trigger('wc_fragments_refreshed');
            }
        },
        error: () => $(document.body).trigger('wc_fragments_ajax_error')
    };

    const refreshCartFragment = () => $.ajax(fragmentRefresh);

    if ($supports_html5_storage) {
        let cart_timeout = null;
        const day_in_ms = 24 * 60 * 60 * 1000;

        $(document.body).on('wc_fragment_refresh updated_wc_div', refreshCartFragment);

        $(document.body).on('added_to_cart removed_from_cart', (e, fragments, cart_hash) => {
            const prev_hash = sessionStorage.getItem(cart_hash_key);
            if (!prev_hash) setCartCreationTimestamp();
            sessionStorage.setItem(wc_cart_fragments_params.fragment_name, JSON.stringify(fragments));
            setCartHash(cart_hash);
        });

        $(document.body).on('wc_fragments_refreshed', () => {
            clearTimeout(cart_timeout);
            cart_timeout = setTimeout(refreshCartFragment, day_in_ms);
        });

        $(window).on('storage onstorage', (e) => {
            if (cart_hash_key === e.originalEvent.key && 
                localStorage.getItem(cart_hash_key) !== sessionStorage.getItem(cart_hash_key)
            ) {
                refreshCartFragment();
            }
        });

        try {
            const fragments = JSON.parse(sessionStorage.getItem(wc_cart_fragments_params.fragment_name));
            const cart_hash = sessionStorage.getItem(cart_hash_key) || '';
            const cookie_hash = Cookies.get('woocommerce_cart_hash') || '';
            const cart_created = sessionStorage.getItem('wc_cart_created');
            const pll_lang = $.cookie('pll_language') || '';

            if (!cart_created) throw 'No cart_created';

            const cart_expiration = parseInt(cart_created) + day_in_ms;
            const timestamp_now = Date.now();

            if (cart_expiration < timestamp_now) throw 'Fragment expired';

            cart_timeout = setTimeout(refreshCartFragment, cart_expiration - timestamp_now);

            if (fragments && fragments['div.widget_shopping_cart_content'] && cart_hash === cookie_hash) {
                $.each(fragments, (key, value) => $(key).replaceWith(value));
                $(document.body).trigger('wc_fragments_loaded');
            } else {
                throw 'No fragment';
            }
        } catch (err) {
            refreshCartFragment();
        }
    } else {
        refreshCartFragment();
    }

    if (Cookies.get('woocommerce_items_in_cart') > 0) {
        $('.hide_cart_widget_if_empty').closest('.widget_shopping_cart').show();
    } else {
        $('.hide_cart_widget_if_empty').closest('.widget_shopping_cart').hide();
    }

    $(document.body).on('adding_to_cart', () => {
        $('.hide_cart_widget_if_empty').closest('.widget_shopping_cart').show();
    });
});
